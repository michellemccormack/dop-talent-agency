<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DOP Viewer</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:760px;margin:24px auto;padding:0 16px}
  .card{border:1px solid #eee;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.05)}
  img{max-width:100%;border-radius:12px}
  audio{width:100%;margin-top:12px}
  .err{color:#b00020;margin-top:12px}
  code{background:#f4f4f4;padding:2px 6px;border-radius:6px}
</style>
<div class="card">
  <h1>Your DOP</h1>
  <div id="out">Loadingâ€¦</div>
</div>
<script>
(async () => {
  const params = new URLSearchParams(location.search);
  let id = params.get('id');

  if (!id) {
    const m = /\/dop\/([^/?#]+)/i.exec(location.pathname);
    if (m) id = decodeURIComponent(m[1]);
  }
  const out = document.getElementById('out');
  if (!id) { out.innerHTML = '<div class="err">Missing dopId</div>'; return; }

  try {
    const res = await fetch(`/.netlify/functions/dop-view?id=${encodeURIComponent(id)}`);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed');

    const imgKey = data.images?.[0]?.key;
    const voiceKey = data.voices?.[0]?.key;

    const imgURL = imgKey ? `/.netlify/functions/dop-file?key=${encodeURIComponent(imgKey)}` : null;
    const audURL = voiceKey ? `/.netlify/functions/dop-file?key=${encodeURIComponent(voiceKey)}` : null;

    out.innerHTML = `
      <div style="font-size:14px;color:#666;margin-bottom:8px">dopId: <code>${data.dopId}</code></div>
      ${imgURL ? `<img alt="DOP image" src="${imgURL}">` : '<div class="err">No image found</div>'}
      ${audURL ? `<audio controls src="${audURL}"></audio>` : '<div class="err">No voice found</div>'}
    `;
  } catch (e) {
    out.innerHTML = `<div class="err">${e.message || e}</div>`;
  }
})();
</script>
