<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Dopple Talent Demo</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0b0c10;
      --bg-grad: radial-gradient(1200px 600px at 50% -220px, rgba(255,255,255,.05), transparent), #0b0c10;
      --card:#111318;
      --text:#e8ecf1;
      --muted:#9aa2b1;
      --chip:#171b24;
      --chipH:#1b2030;
      --bd:rgba(255,255,255,0.08);
      --shadow: 0 16px 44px rgba(0,0,0,.46);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg-grad);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      justify-content:center;
    }

    .shell{max-width:980px;width:100%;padding:52px 24px 70px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.18)), var(--card);
      border:1px solid var(--bd);
      border-radius:28px;
      box-shadow:var(--shadow);
      padding:34px 22px 32px;
      margin:0 auto;
      max-width:860px;
      text-align:center;
    }

    .btn{
      appearance:none;
      border:1px solid var(--bd);
      background:#161a24;
      color:var(--text);
      border-radius:999px;
      padding:14px 26px;
      font-weight:800;
      font-size:15px;
      letter-spacing:.3px;
      cursor:pointer;
      transition:background .15s ease, transform .04s ease;
    }
    .btn:hover{background:#1b2030}
    .btn:active{transform:translateY(1px) scale(.995)}

    .status{margin:10px 0 18px; color:var(--muted); font-size:12px; font-weight:700}

    .headline{
      margin:6px 0 4px;
      font-weight:800;
      font-size:18px;
      letter-spacing:.5px;
      text-transform:uppercase;
    }
    .helper{
      color:var(--muted);
      font-size:11px;
      letter-spacing:.4px;
      text-transform:uppercase;
      margin-bottom:12px;
    }

    .chips{
      display:flex; flex-wrap:wrap; gap:12px; justify-content:center;
      margin:10px 0 18px; padding:0 6px;
    }
    .chip{
      user-select:none;
      padding:11px 18px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--bd);
      color:var(--text);
      font-weight:900;
      font-size:12px;
      letter-spacing:.25px;
      cursor:pointer;
      transition:background .15s ease, transform .04s ease;
      white-space:nowrap;
      text-transform:uppercase;
    }
    .chip:hover{background:var(--chipH)}
    .chip:active{transform:translateY(1px)}

    .video-wrap{
      display:flex;
      justify-content:center;
      margin:22px 0 20px;
    }
    video#avatar{
      width:560px;
      max-width:92vw;
      background:#000;
      border-radius:20px;
      border:1px solid var(--bd);
      box-shadow:0 18px 30px rgba(0,0,0,.38);
      aspect-ratio: 9 / 16;
      object-fit: cover;
    }

    .row-bottom{display:flex; justify-content:center; margin-top:16px}
    footer{margin-top:22px; color:var(--muted); font-size:12px; text-align:center}
    audio#tts{display:none}

    @media (max-width:560px){
      .shell{padding:40px 16px 56px}
      .btn{padding:12px 20px; font-size:14px}
      .chip{padding:10px 14px; font-size:11px}
      video#avatar{width:420px}
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <button id="mic-btn" class="btn">üé§ TAP TO TALK</button>
      <div id="status" class="status">Ready</div>

      <div class="headline">ASK SASHA ONE OF THESE 3 QUESTIONS.</div>
      <div class="helper">IF YOUR MICROPHONE DOESN‚ÄôT WORK, TAP THE QUESTION.</div>

      <div class="chips">
        <div class="chip" data-tts="What do you like to do for fun?">WHAT DO YOU LIKE TO DO FOR FUN?</div>
        <div class="chip" data-tts="Where are you from?">WHERE ARE YOU FROM?</div>
        <div class="chip" data-tts="What‚Äôs your favorite way to relax?">WHAT‚ÄôS YOUR FAVORITE WAY TO RELAX?</div>
      </div>

      <!-- Placeholder loop (Phase-1 baseline) -->
      <div class="video-wrap">
        <!-- Step 19.1: harmless hook so we can toggle a live avatar later -->
        <video id="avatar" data-avatar="placeholder" autoplay muted loop playsinline preload="auto">
          <source src="assets/real.mp4" type="video/mp4" />
          Your browser does not support the video tag.
        </video>
      </div>

      <div class="row-bottom">
        <button id="stop-tts-btn" class="btn">‚èπ Stop</button>
      </div>
    </div>

    <footer>AI built by Michelle McCormack</footer>
  </div>

  <!-- ElevenLabs audio (Task 18) -->
  <audio id="tts" preload="none"></audio>

  <script>
    const statusEl = document.getElementById('status');
    const audioEl  = document.getElementById('tts');
    const micBtn   = document.getElementById('mic-btn');
    const baseVid  = document.getElementById('avatar');

    function setStatus(t){ statusEl.textContent = t; }

    // Ensure the placeholder video shows immediately
    window.addEventListener('DOMContentLoaded', ()=>{
      baseVid.play().catch(()=>{ /* autoplay might be blocked; user gesture will start it */ });
    });

    // Progressive ElevenLabs playback (Task 18)
    async function speak(text){
      if(!text || !text.trim()) return;
      try{
        try{ audioEl.pause(); audioEl.currentTime = 0; }catch{}
        const url = `/.netlify/functions/tts-eleven?q=${encodeURIComponent(text)}&ts=${Date.now()}`;
        audioEl.src = url;
        await audioEl.play();
        setStatus('Speaking‚Ä¶');
      }catch{
        setStatus('Audio error');
      }
    }
    document.getElementById('stop-tts-btn').addEventListener('click', ()=>{
      try{ audioEl.pause(); audioEl.currentTime = 0; }catch{}
      setStatus('Stopped.');
    });
    audioEl.addEventListener('ended', ()=> setStatus('Ready'));
    audioEl.addEventListener('error', ()=> setStatus('Audio error'));

    // Prompt chips ‚Üí speak text
    document.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-tts]');
      if(!el) return;
      speak(el.getAttribute('data-tts') || el.textContent || '');
    });

    // Desktop Web Speech mic (Phase-1 behavior)
    let recognition = null, listening = false;
    function wsrSupported(){ return ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window); }
    function createWSR(){
      const Ctor = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new Ctor();
      rec.lang = 'en-US'; rec.continuous = false; rec.interimResults = false;
      return rec;
    }
    function startMic(){
      if(!wsrSupported()){ setStatus('Speech recognition not supported'); return; }
      if(!recognition){
        recognition = createWSR();
        recognition.onstart = ()=>{ listening = true; setStatus('Listening‚Ä¶'); };
        recognition.onerror = (e)=>{ listening = false; setStatus('Mic error: ' + e.error); };
        recognition.onend = ()=>{ listening = false; if(statusEl.textContent==='Listening‚Ä¶') setStatus('Ready'); };
        recognition.onresult = (e)=>{
          const text = e.results?.[0]?.[0]?.transcript || '';
          speak(text);
        };
      }
      try{ recognition.start(); }catch{}
    }
    function stopMic(){ if(recognition && listening) recognition.stop(); }
    micBtn.addEventListener('mousedown', startMic);
    micBtn.addEventListener('mouseup', stopMic);
    micBtn.addEventListener('mouseleave', stopMic);
    micBtn.addEventListener('keydown', (e)=>{ if(e.code==='Space'||e.code==='Enter'){ e.preventDefault(); startMic(); }});
    micBtn.addEventListener('keyup',   (e)=>{ if(e.code==='Space'||e.code==='Enter'){ e.preventDefault(); stopMic(); }});
  </script>
</body>
</html>
