<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dopple Admin — Recent DOP Uploads</title>
  <style>
    :root{--ink:#111;--muted:#666;--line:#e7e7e7;--bg:#fff;}
    html,body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;}
    .wrap{max-width:960px;margin:28px auto;padding:0 16px;}
    h1{margin:0 0 8px;font-size:24px}
    .bar{display:flex;gap:8px;align-items:center;margin:10px 0 16px}
    input[type=text]{padding:10px 12px;border:1px solid var(--line);border-radius:10px;min-width:260px}
    button{padding:10px 14px;border:0;background:#111;color:#fff;border-radius:10px;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);text-align:left;padding:10px 8px;font-size:14px;vertical-align:top}
    th{font-size:12px;color:var(--muted);letter-spacing:.02em;text-transform:uppercase}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .muted{color:var(--muted)}
    .ok{background:#e8f8ed;border:1px solid #bfe7cc;padding:8px 10px;border-radius:10px;margin-top:10px;display:inline-block}
    .err{background:#fdecec;border:1px solid #f3c1c1;padding:8px 10px;border-radius:10px;margin-top:10px;display:inline-block;color:#b00020;white-space:pre-wrap}
    a{color:#111}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin QA — Recent DOP uploads</h1>
    <div class="bar">
      <input id="key" type="text" placeholder="Enter ADMIN_KEY" />
      <button id="load">Load</button>
      <span class="muted">URL also works: <span class="mono">/admin.html?key=…</span></span>
    </div>
    <div id="msg" class="muted"></div>
    <div style="overflow:auto;">
      <table id="tbl" style="display:none">
        <thead>
          <tr>
            <th>DOP ID</th>
            <th>Created</th>
            <th>Image</th>
            <th>Voice</th>
            <th>Viewer</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const params = new URLSearchParams(location.search);
    const keyFromQS = params.get('key') || '';
    const KEY_STORAGE = 'dop_admin_key';

    if (keyFromQS) {
      localStorage.setItem(KEY_STORAGE, keyFromQS);
    }
    $('key').value = keyFromQS || localStorage.getItem(KEY_STORAGE) || '';

    $('load').addEventListener('click', load);
    if ($('key').value) load();

    async function load(){
      const key = $('key').value.trim();
      if (!key) return note('Enter your ADMIN_KEY.');
      localStorage.setItem(KEY_STORAGE, key);
      note('Loading…');
      $('tbl').style.display = 'none';
      $('rows').innerHTML = '';

      try {
        const res = await fetch(`/.netlify/functions/dop-list-recent?key=${encodeURIComponent(key)}&limit=50`, {
          method: 'GET',
          headers: { 'accept':'application/json' }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        if (!data.items || !data.items.length) {
          note('No uploads found yet.');
          return;
        }

        for (const m of data.items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="mono">${m.dopId}</td>
            <td><span class="mono">${(m.createdAt || '').replace('T',' ').replace('Z','')}</span></td>
            <td>
              <div class="mono">${m.image?.key || ''}</div>
              <div class="muted">${m.image?.contentType || ''} • ${fmtBytes(m.image?.bytes)}</div>
            </td>
            <td>
              <div class="mono">${m.voice?.key || ''}</div>
              <div class="muted">${m.voice?.contentType || ''} • ${fmtBytes(m.voice?.bytes)}</div>
            </td>
            <td><a href="/dop/${m.dopId}" target="_blank">/dop/${m.dopId}</a></td>
          `;
          $('rows').appendChild(tr);
        }
        $('tbl').style.display = '';
        note(`Loaded ${data.items.length} item(s).`);
      } catch (err) {
        error(err.message || String(err));
      }
    }

    function note(msg){ $('msg').className='ok'; $('msg').textContent = msg; }
    function error(msg){ $('msg').className='err'; $('msg').textContent = msg; }
    function fmtBytes(n){
      n = Number(n||0);
      if (!n) return '';
      const u = ['B','KB','MB','GB']; let i=0;
      while(n >= 1024 && i < u.length-1){ n/=1024; i++; }
      return `${n.toFixed(1)} ${u[i]}`;
    }
  </script>
</body>
</html>
