<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOPPLE â€” Live Log</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin: 24px; background:#0b0b0d; color:#eaeaf2; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    input, select, button { background:#15151a; color:#eaeaf2; border:1px solid #2a2a33; border-radius:8px; padding:8px 10px; }
    button { cursor:pointer; }
    table { width:100%; border-collapse: collapse; margin-top:8px; }
    th, td { border-bottom:1px solid #22222a; padding:8px; vertical-align: top; }
    th { text-align:left; font-weight:600; color:#b9b9c7; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; word-break: break-word; }
    .row { background:#0f0f14; }
    .tag { display:inline-block; padding:2px 6px; border:1px solid #2a2a33; border-radius:999px; margin-right:6px; font-size:12px; color:#cfd0dc; }
    .ok { color:#8affc1; }
  </style>
</head>
<body>
  <h1>ðŸ§¾ DOPPLE â€” Live Log</h1>

  <div class="controls">
    <label>Limit <input id="limit" type="number" min="1" max="2000" value="200"></label>
    <label>Auto-refresh <select id="auto"><option value="on" selected>On</option><option value="off">Off</option></select></label>
    <button id="refresh">Refresh</button>
    <a id="download" href="/.netlify/functions/log_view?format=raw" target="_blank"><button>Download raw JSONL</button></a>
    <span id="status">loadingâ€¦</span>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:180px">Time (UTC)</th>
        <th style="width:140px">Step</th>
        <th>Summary</th>
        <th style="width:220px">Details</th>
        <th style="width:220px">Tags</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const endpoint = "/.netlify/functions/log_view";
    const tbody = document.querySelector("tbody");
    const statusEl = document.getElementById("status");
    const limitEl = document.getElementById("limit");
    const autoEl = document.getElementById("auto");
    const refreshBtn = document.getElementById("refresh");
    const downloadA = document.getElementById("download");
    let timer = null;

    async function fetchLog() {
      const limit = parseInt(limitEl.value || "200", 10);
      const url = `${endpoint}?limit=${limit}`;
      statusEl.textContent = "loadingâ€¦";
      try {
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json();
        render(data.items || []);
        statusEl.innerHTML = `<span class="ok">ok</span> (${(data.items||[]).length} entries)`;
      } catch (e) {
        statusEl.textContent = "error: " + e.message;
      }
    }

    function render(items) {
      tbody.innerHTML = "";
      for (const it of items) {
        const tr = document.createElement("tr");
        tr.className = "row";
        const ts = new Date(it.ts || Date.now()).toISOString().replace("T"," ").replace("Z","");
        tr.innerHTML = `
          <td class="mono">${ts}</td>
          <td class="mono">${escapeHtml(it.step || "")}</td>
          <td>${escapeHtml(it.summary || "")}</td>
          <td class="mono">${escapeHtml(it.details || "")}</td>
          <td>${(it.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function startAuto() {
      if (timer) clearInterval(timer);
      if (autoEl.value === "on") {
        timer = setInterval(fetchLog, 3000);
      }
    }

    refreshBtn.onclick = fetchLog;
    limitEl.onchange = () => { fetchLog(); startAuto(); };
    autoEl.onchange = startAuto;

    // init
    fetchLog();
    startAuto();
  </script>
</body>
</html>
