<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Your DOP - Dopple Talent Agency</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0e0f12; --bg-2:#08090c;
      --panel:#12131a; --panel-2:#1a1b25;
      --text:#ececf1; --muted:#b7b8c3;
      --stroke:#26283a; --stroke-strong:#3a3b52;
      --accent:#8a8cff; --ok:#16db65; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
    }
    
    *{box-sizing:border-box}
    html,body{height:100%}
    
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text); line-height:1.5;
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(94,97,255,.12), transparent 40%),
        radial-gradient(900px 480px at 0% 110%, rgba(138,140,255,.10), transparent 45%),
        linear-gradient(180deg,var(--bg),var(--bg-2));
      min-height:100vh; padding:20px;
    }

    .container{max-width:800px; margin:0 auto}
    
    .header{text-align:center; margin-bottom:40px}
    .header h1{
      font-family:'Montserrat',sans-serif; font-weight:800; font-size:2.5rem;
      background:linear-gradient(135deg,#fff,#d1d5db); 
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      margin:0 0 8px;
    }
    .header p{color:var(--muted); font-size:1.1rem; margin:0}

    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid var(--stroke); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:32px; margin-bottom:24px;
    }

    .upload-grid{display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:24px}
    
    .upload-box{
      border:2px dashed var(--stroke); border-radius:var(--radius);
      padding:32px 20px; text-align:center; cursor:pointer;
      transition:all .2s ease; background:rgba(255,255,255,.02);
    }
    .upload-box:hover{border-color:var(--accent); background:rgba(138,140,255,.05)}
    .upload-box.has-file{border-color:var(--ok); border-style:solid}
    
    .upload-box input[type="file"]{display:none}
    .upload-box .icon{font-size:2.5rem; margin-bottom:12px; opacity:.6}
    .upload-box .label{font-weight:600; margin-bottom:4px}
    .upload-box .hint{font-size:13px; color:var(--muted)}
    .upload-box .filename{
      font-size:12px; color:var(--ok); margin-top:8px; font-weight:600;
      word-break:break-all;
    }

    .form-group{margin-bottom:24px}
    .form-group label{
      display:block; font-weight:600; margin-bottom:8px; color:var(--text);
    }
    .form-group input, .form-group textarea{
      width:100%; padding:12px 16px; border:1px solid var(--stroke);
      border-radius:12px; background:var(--panel-2); color:var(--text);
      font-size:16px; transition:border-color .2s ease; font-family:inherit;
    }
    .form-group input:focus, .form-group textarea:focus{outline:none; border-color:var(--accent)}
    .form-group textarea{resize:vertical}

    .create-btn{
      width:100%; padding:16px 32px; border:none; border-radius:16px;
      background:linear-gradient(135deg,var(--accent),#9b9dff);
      color:#000; font-size:18px; font-weight:800; font-family:'Montserrat',sans-serif;
      text-transform:uppercase; cursor:pointer; transition:all .2s ease;
      box-shadow:0 8px 24px rgba(138,140,255,.3);
    }
    .create-btn:hover{transform:translateY(-2px); box-shadow:0 12px 32px rgba(138,140,255,.4)}
    .create-btn:disabled{opacity:.5; cursor:not-allowed; transform:none}

    .status{
      padding:12px 16px; border-radius:12px; margin-bottom:16px;
      font-weight:600; text-align:center; display:none;
    }
    .status.error{background:rgba(255,107,107,.1); border:1px solid #ff6b6b; color:#ff6b6b}
    .status.success{background:rgba(22,219,101,.1); border:1px solid var(--ok); color:var(--ok)}

    @media (max-width:768px){
      .upload-grid{grid-template-columns:1fr}
      .card{padding:24px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Create Your DOP</h1>
      <p>Upload your photo and voice sample to create an AI doppelgÃ¤nger</p>
    </div>

    <div class="card">
      <!-- Upload Section -->
      <div class="upload-grid">
        <!-- Photo Upload -->
        <div class="upload-box" id="photoBox">
          <input type="file" id="photoInput" accept="image/*" />
          <div class="icon">ðŸ“·</div>
          <div class="label">Upload Photo</div>
          <div class="hint">JPG, PNG up to 5MB<br>Clear face photo works best</div>
          <div class="filename" id="photoFilename"></div>
        </div>

        <!-- Voice Upload -->
        <div class="upload-box" id="voiceBox">
          <input type="file" id="voiceInput" accept="audio/*" />
          <div class="icon">ðŸŽ¤</div>
          <div class="label">Upload Voice Sample</div>
          <div class="hint">MP3, WAV up to 10MB<br>30+ seconds recommended</div>
          <div class="filename" id="voiceFilename"></div>
        </div>
      </div>

      <!-- DOP Details -->
      <div class="form-group">
        <label for="dopName">DOP Name (optional)</label>
        <input type="text" id="dopName" placeholder="What should we call your DOP?" />
      </div>
      
      <div class="form-group">
        <label for="dopBio">Bio/Personality (optional but recommended)</label>
        <textarea id="dopBio" rows="3" placeholder="Tell us about yourself - your personality, interests, background, etc. The more detail you provide, the better your DOP will be at conversations!"></textarea>
      </div>

      <!-- Status Messages -->
      <div id="status" class="status"></div>

      <!-- Create Button -->
      <button class="create-btn" id="createBtn" disabled>
        Upload Files to Continue
      </button>
    </div>
  </div>

  <script>
    // State
    let photoFile = null;
    let voiceFile = null;

    // Elements
    const photoBox = document.getElementById('photoBox');
    const voiceBox = document.getElementById('voiceBox');
    const photoInput = document.getElementById('photoInput');
    const voiceInput = document.getElementById('voiceInput');
    const photoFilename = document.getElementById('photoFilename');
    const voiceFilename = document.getElementById('voiceFilename');
    const dopNameInput = document.getElementById('dopName');
    const dopBioInput = document.getElementById('dopBio');
    const createBtn = document.getElementById('createBtn');
    const status = document.getElementById('status');

    // File Upload Handlers
    photoBox.addEventListener('click', () => photoInput.click());
    voiceBox.addEventListener('click', () => voiceInput.click());

    photoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          showStatus('error', 'Photo must be under 5MB');
          return;
        }
        photoFile = file;
        photoFilename.textContent = file.name;
        photoBox.classList.add('has-file');
        updateCreateButton();
      }
    });

    voiceInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 10 * 1024 * 1024) {
          showStatus('error', 'Voice file must be under 10MB');
          return;
        }
        voiceFile = file;
        voiceFilename.textContent = file.name;
        voiceBox.classList.add('has-file');
        updateCreateButton();
      }
    });

    // Update Create Button
    function updateCreateButton() {
      if (photoFile && voiceFile) {
        createBtn.disabled = false;
        createBtn.textContent = 'Create My DOP';
      } else {
        createBtn.disabled = true;
        createBtn.textContent = 'Upload Files to Continue';
      }
    }

    // Show Status
    function showStatus(type, message) {
      status.className = `status ${type}`;
      status.textContent = message;
      status.style.display = 'block';
      if (type !== 'loading') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 5000);
      }
    }

    // Create DOP
    createBtn.addEventListener('click', async () => {
      if (!photoFile || !voiceFile) return;

      showStatus('loading', 'Creating your DOP...');
      createBtn.disabled = true;

      try {
        // Convert files to base64
        const [photoBase64, voiceBase64] = await Promise.all([
          fileToBase64(photoFile),
          fileToBase64(voiceFile)
        ]);

        // Create DOP with files
        const uploadResponse = await fetch('/.netlify/functions/dop-uploads', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            imageBase64: photoBase64.split(',')[1], // Remove data:image/...;base64, prefix
            imageType: photoFile.type,
            imageName: photoFile.name,
            audioBase64: voiceBase64.split(',')[1], // Remove data:audio/...;base64, prefix
            audioType: voiceFile.type,
            audioName: voiceFile.name,
            dopName: dopNameInput.value.trim() || null,
            bio: dopBioInput.value.trim() || ''
          })
        });

        const uploadData = await uploadResponse.json();
        
        if (!uploadResponse.ok) {
          throw new Error(uploadData.error || 'Upload failed');
        }

        showStatus('success', `DOP created successfully! ID: ${uploadData.dopId}`);
        
        // Redirect to chat page after a moment
        setTimeout(() => {
          window.location.href = `/chat/${uploadData.dopId}`;
        }, 2000);

      } catch (error) {
        console.error('Error:', error);
        showStatus('error', error.message || 'Failed to create DOP. Please try again.');
        createBtn.disabled = false;
      }
    });

    // Helper: Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>